# PROFUNGIS_post_processing 

**Definition**: 
- PROFUNGIS_post_processing uploads ZOTUs (Zero-OTUs) sample FASTA files into a reference ZOTU table (.csv)

**Repository overview**:
- scripts (.py)
  - generate_zotu_ref1.py : generate reference table
  - update_ref_map.py : append only new ZOTUs in reference ZOTU table
- Dockerfile : commands for setting up local env
- requirements (.txt) : list of dependencies and versions used for the scripts to be able to run

## Script List

*pre-requirement*

Please note that startPROFUNGIS.py of [PROFUNGIS](https://github.com/naturalis/mycodiversity/tree/master/PROFUNGIS) is the first code of the mycodiversity pipeline set. This code needs to be launched before using the input post-processing input files.
PROFUNGIS output fasta files are the inputs for updating MDDB tables refseq ZOTU and contains (ZOTU - sample mapping). 
The output fasta file of PROFUNGIS is provided in this format: SRR1502226_zotus_final.fa where the number followed by SRR is the original sequence run ID file. 

### **Script1**

- **name**: generate_zotu_ref1.py
- **description**: generate_zotu_ref1.py allows to generate a reference file from a FASTA format and appends attributes which can be used as a template to upload to the Entity ZOTU of MDDB.

**What it does**

**Input**
- Arguments
  - arg1 : FASTA file (.fa)
  - arg2 : requests if the user would like to generate primary keys for the FASTA sequences ("Y"/"N")
    	- If second argument = 'Y', then a csv file is generated in which it includes a 'refseq_pk' 
which is generated by using a specific suffix used to refer to the db table belonging to 
the ZOTU reference set.
	- If second argument == 'N', then a csv file is generated in which it includes the labels 'seq_id' taken
from the original FASTA sequence label, followed by a sequence attribute 'sequence' which contains 
the sequence belonging to the ITS2 marker in this case

A relationship table is also created in which the following mapping is stored: 
Attribute list:
- SRR_name : SRR id reference
- ZOTU_label : ID for ZOTU sequence
- ZOTU_PK : Primary key assigned to the Zotu label

### **Script2**

- **name**: update_ref_map.py
- **description**: update_ref_map.py allows to update the ZOTU reference file with new ZOTUs and keeps track of existing ZOTUs detected in reference

**What it does**

This script can be run sequentially to a reference ZOTU file generated (i.e. by launching <generate_zotu_ref1.py>), 
as it updates and traces existing ZOTU sequences (ZOTU detected).

**Input**
- Arguments : requests one FASTA argument from the user.
  - it accepts a FASTA file (.fa) that contains the FASTA sequences
- Requirements :
  - a ZOTU reference file must be provided. This can be obtained for example by dumping a MDDB ZOTU fasta file for instance.
  - previous tracker of mapping reference. This is used to keep track with how many new ZOTU sequences will be generated as reference and which ones become new ZOTUs.

A relational table is also generated to keep a mapping RefZOTU - NewZOTU in the following attribute list:
The script also generates a mapping RefZOTU - NewZOTU in the following format:  
SRR id | Zotu label | Primary key of ref ZOTU
and assigns new primary keys to the new ZOTUs not detected as a reference ZOTU, else provides the mapping of ZOTUs which have been already detected
to a reference ZOTU, thus the primary key of the reference ZOTU is given 

This mapping is useful such that it provides two types of information:
- traces and provides which ZOTUs are new, 
- traces which ZOTUs are shared among different samples

### How to run the scripts

#### generate_zotu_ref1.py

```shell
python3 generate_zotu_ref1.py <srr_filename.fa> "Y"/"N"
```
where <srr_filename.fa> is in FASTA format 

#### update_ref_map.py

```shell
python3 update_ref_map.py <srr_filename.fa> <RefZOTU.csv> <mapping.csv>
```
	
where	<srr_filename.fa> -- is the next (new) processed ZOTU file (FASTA format) generated by PROFUNGIS
		<RefZOTU.csv> -- ZOTU reference file (unique ZOTUs)
		<mapping.csv> -- the mapping table which keeps track of which ZOTU sequence belongs to which sequence sample 
		HINT: for testing you can use the output files generated by generate_zotu_ref1.py
		(ex: generate_zotu_ref1.py <newfasta.fa> <refseq_table_pk.csv> <mapping_table_pk_zotu_srr.csv>)

 
### Requirements for scripts

- generate_zotu_ref1.py
	- csv
	- pandas
	- re
	- Bio


update_ref_map.py
	- csv
	- pandas
	- re
	- Bio 

- *note that the pandas library version used can be found in the requirements.txt file provided in this folder.*

### PROFUNGIS_post_processing docker steps - helping to run the scripts in your own machine

## Pre-requirements for running the post_processing container

1. install Docker: [Docker installation](https://docs.docker.com/get-docker/). This main page contains instructions for *Windows*, *OS mac* and *Linux*.
2. have a GitHub account.

## Run docker steps

1. Clone this repository. For instructions how to clone repositories you can find here [clone](https://docs.github.com/en/repositories/creating-and-managing-repositories/cloning-a-repository)

2. Start Docker. Docker application also provides Docker Desktop, which is a handy interface to create images and install the container. Below i give the commands for running on the terminal. I run the docker in the same path I cloned the repository, else make sure you know the PATH of where you cloned the repository. The *docker* term is used for running commands. 

3. Build a Docker image. Provide a name for your image so you can refer to it later. To build an image, use the build command of docker. 

```shell
docker build -t image-post_processing .  
```

where image-post_processing is the name of the image

4. Run the container by using the image you created in step 3.

```shell
docker run image-post_processing SRR1502226_zotus_final.fa Y 
```

Because the DOCKER file contains the entrypoint for running the python script, this means that only the parameters required are necessary to run the script. In this case, the fasta file and if you want to have generate the primary keys for your DNA sequences. 
If no fasta file was generated with the startPROFUNGIS pipeline, one can always use FASTA files found in this repo [test_zotu](). 

### OUTPUTS

- generate_zotu_ref1.py -> ZOTU reference file with extended annotation

outputs:

	> mapping_table_pk_zotu_srr.csv -> traces the mapping of the original Fasta Label to assigned PK
	> otu_seq_mapping_to_update.csv -> a simple reference ZOTU table generated from the given FASTA
	> record_track.csv -> tracker of how many reference ZOTUs have been generated
	> refseq_table_pk.csv -> the ZOTU list with extended annotation used as reference


- update_ref_map.py -> update ZOTU reference table and mappings
	
outputs:
	
 	> mapping_table_pk_zotu_srr.csv -> updates the mapping table of the original Fasta Label to assigned PK or to new PK generated if not found
	>otu_seq_mapping_to_update.csv -> provides the table format of the new ZOTUs coming in for update
	>record_track.csv -> updates the tracker of how many reference ZOTUs have been generated from the new FASTA
	>refseq_table_pk.csv -> the updated ZOTU list with new PK generated if new ZOTU was detected

Note that if you want to access this output by running the docker, you can access it in a mounted directory. Here we provide an instruction on how to provide a mounted directory for accessing the output files (the output will be stored in the output_data folder, wheere you can access them locally in your input_data folder 

```shell
docker run  --rm -v $(pwd)/input_data:/ouput_data image-post_processing SRR1502226_zotus_final.fa Y 
```





