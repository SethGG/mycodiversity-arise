# PROFUNGIS_post_processing 

**Definition**: 
- PROFUNGIS_post_processing uploads ZOTUs (Zero-OTUs) sample FASTA files into a reference ZOTU table (.csv)

**Repository overview**:
- scripts (.py)
  - generate_zotu_ref1.py : generate reference table
  - update_ref_map.py : append only new ZOTUs in reference ZOTU table
- Dockerfile : commands for setting up local env
- requirements (.txt) : list of dependencies and versions used for the scripts to be able to run

## Script List

*pre-requirement*

Please note that startPROFUNGIS.py of [PROFUNGIS](https://github.com/naturalis/mycodiversity/tree/master/PROFUNGIS) is the first code of the mycodiversity pipeline set. This code needs to be launched before using the input post-processing input files.
PROFUNGIS output fasta files are the inputs for updating MDDB tables refseq ZOTU and contains (ZOTU - sample mapping)


### **Script1**

- **name**: generate_zotu_ref1.py
- **description**: generate_zotu_ref1.py allows to generate a reference file from a FASTA format and appends attributes which can be used as a template to upload to the Entity ZOTU of MDDB.

**What it does**

**Input**
- Arguments
  - arg1 : FASTA file (.fa)
  - arg2 : requests if the user would like to generate primary keys for the FASTA sequences ("Y"/"N")
    	- If second argument = 'Y', then a csv file is generated in which it includes a 'refseq_pk' 
which is generated by using a specific suffix used to refer to the db table belonging to 
the ZOTU reference set.
	- If second argument == 'N', then a csv file is generated in which it includes the labels 'seq_id' taken
from the original FASTA sequence label, followed by a sequence attribute 'sequence' which contains 
the sequence belonging to the ITS2 marker in this case

```shell
python3 generate_zotu_ref1.py 
```

A relationship table is also created in which the following mapping is stored: 
Attribute list:
- SRR_name : SRR id reference
- ZOTU_label : ID for ZOTU sequence
- ZOTU_PK : Primary key assigned to the Zotu label

### **Script2**

- **name**: update_ref_map.py
- **description**: update_ref_map.py allows to update the ZOTU reference file with new ZOTUs and keeps track of existing ZOTUs detected in reference

**What it does**

This script can be run sequentially to a reference ZOTU file generated (i.e. by launching <generate_zotu_ref1.py>), 
as it updates and traces existing ZOTU sequences (ZOTU detected).

**Input**
- Arguments : requests one FASTA argument from the user.
  - it accepts a FASTA file (.fa) that contains the FASTA sequences
- Requirements :
  - a ZOTU reference file must be provided. This can be obtained for example by dumping a MDDB ZOTU fasta file for instance.
  - previous tracker of mapping reference. This is used to keep track with how many new ZOTU sequences will be generated as reference and which ones become new ZOTUs.

A relational table is also generated to keep a mapping RefZOTU - NewZOTU in the following attribute list:
The script also generates a mapping RefZOTU - NewZOTU in the following format:  
SRR id | Zotu label | Primary key of ref ZOTU
and assigns new primary keys to the new ZOTUs not detected as a reference ZOTU, else provides the mapping of ZOTUs which have been already detected
to a reference ZOTU, thus the primary key of the reference ZOTU is given 

This mapping is useful such that it provides two types of information:
- traces and provides which ZOTUs are new, 
- traces which ZOTUs are shared among different samples

### How to run the scripts

#### generate_zotu_ref1.py

	> generate_zotu_ref1.py <srr_filename.fa> 

where <srr_filename.fa> is in FASTA format -- PROFUNGIS generates ZOTU fasta files with name belonging to the SRA SRR. 
  	(ex: SRR1502226_zotus_final.fa))


#### update_ref_map.py
	> update_ref_map.py <srr_filename.fa> <RefZOTU.csv> <mapping.csv>
	
where	<srr_filename.fa> -- is the next (new) processed ZOTU file (FASTA format) generated by PROFUNGIS
		<RefZOTU.csv> -- ZOTU reference file (unique ZOTUs)
		<mapping.csv> -- the mapping table which keeps track of which ZOTU sequence belongs to which sequence sample 
		HINT: for testing you can use the output files generated by generate_zotu_ref1.py
		(ex: generate_zotu_ref1.py <newfasta.fa> <refseq_table_pk.csv> <mapping_table_pk_zotu_srr.csv>)

 
### Requirements

generate_zotu_ref1.py
- csv
- pandas
- re
- Bio


update_ref_map.py
- csv
- pandas
- re
- Bio 


### OUTPUTS

- generate_zotu_ref1.py -> ZOTU reference file with extended annotation

outputs:

	> mapping_table_pk_zotu_srr.csv -> traces the mapping of the original Fasta Label to assigned PK
	> otu_seq_mapping_to_update.csv -> a simple reference ZOTU table generated from the given FASTA
	> record_track.csv -> tracker of how many reference ZOTUs have been generated
	> refseq_table_pk.csv -> the ZOTU list with extended annotation used as reference


- update_ref_map.py -> update ZOTU reference table and mappings
	
outputs:
	
 	> mapping_table_pk_zotu_srr.csv -> updates the mapping table of the original Fasta Label to assigned PK or to new PK generated if not found
	>otu_seq_mapping_to_update.csv -> provides the table format of the new ZOTUs coming in for update
	>record_track.csv -> updates the tracker of how many reference ZOTUs have been generated from the new FASTA
	>refseq_table_pk.csv -> the updated ZOTU list with new PK generated if new ZOTU was detected





